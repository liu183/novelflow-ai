"""æç¤ºè¯æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ."""
from typing import Dict, List, Optional, Any
from dataclasses import dataclass
from enum import Enum


class PromptCategory(Enum):
    """æç¤ºè¯ç±»åˆ«."""

    INSPIRATION = "inspiration"
    STRUCTURE = "structure"
    CHARACTER = "character"
    PLOT = "plot"
    DIALOGUE = "dialogue"
    SCENE = "scene"
    RHYTHM = "rhythm"
    EDITING = "editing"


@dataclass
class TemplateVariable:
    """æ¨¡æ¿å˜é‡å®šä¹‰."""

    name: str
    type: str  # string, number, array, object, enum
    required: bool
    description: str
    default_value: Optional[Any] = None
    options: Optional[List[Any]] = None


@dataclass
class PromptTemplate:
    """æç¤ºè¯æ¨¡æ¿."""

    id: str
    name: str
    category: PromptCategory
    template: str
    variables: List[TemplateVariable]
    version: str = "1.0.0"
    examples: Optional[List[Dict[str, Any]]] = None
    is_active: bool = True


# æç¤ºè¯æ¨¡æ¿åº“
PROMPT_TEMPLATES: Dict[str, PromptTemplate] = {
    # ========== çµæ„Ÿå¼€å‘æ¨¡æ¿ ==========
    "inspiration_development": PromptTemplate(
        id="inspiration_development",
        name="çµæ„Ÿæ·±åº¦å¼€å‘",
        category=PromptCategory.INSPIRATION,
        template="""# è§’è‰²ï¼šå°è¯´çµæ„Ÿå¼€å‘ä¸“å®¶

## ä»»åŠ¡
åŸºäºç”¨æˆ·æä¾›çš„çµæ„Ÿç¢ç‰‡ï¼Œè¿›è¡Œæ·±åº¦å¼€å‘å’Œæ‰©å±•ã€‚

## è¾“å…¥ä¿¡æ¯
- çµæ„Ÿå†…å®¹ï¼š{{inspiration_content}}
- çµæ„Ÿç±»å‹ï¼š{{inspiration_type}}
- åå¥½ç±»å‹ï¼š{{preferred_genre}}

## è¾“å‡ºè¦æ±‚

### 1. çµæ„Ÿåˆ†æ
- çµæ„Ÿåˆ†ç±»ï¼š[è‡ªåŠ¨åˆ¤æ–­]
- æ ¸å¿ƒå…ƒç´ æå–ï¼š[3-5ä¸ªå…³é”®è¯]
- æ½œåœ¨ç±»å‹è¯†åˆ«ï¼š[2-3ä¸ªå¯èƒ½ç±»å‹]

### 2. å†²çªæ„å»ºï¼ˆåº”ç”¨å…¬å¼ï¼šæ—¥å¸¸+åå¸¸=æˆå‰§æ€§ï¼‰

#### æ–¹æ¡ˆAï¼š{{conflict_type_1}}
- **æ—¥å¸¸å…ƒç´ **ï¼š{{routine_element_1}}
- **åå¸¸å…ƒç´ **ï¼š{{abnormal_element_1}}
- **æ˜ç¡®ç›®æ ‡**ï¼š{{goal_1}}
- **å¼ºåŠ²é˜»ç¢**ï¼š{{obstacle_1}}
- **æ— æ³•é€ƒé¿**ï¼š{{inescapable_1}}

#### æ–¹æ¡ˆBï¼š{{conflict_type_2}}
- **æ—¥å¸¸å…ƒç´ **ï¼š{{routine_element_2}}
- **åå¸¸å…ƒç´ **ï¼š{{abnormal_element_2}}
- **æ˜ç¡®ç›®æ ‡**ï¼š{{goal_2}}
- **å¼ºåŠ²é˜»ç¢**ï¼š{{obstacle_2}}
- **æ— æ³•é€ƒé¿**ï¼š{{inescapable_2}}

#### æ–¹æ¡ˆCï¼š{{conflict_type_3}}
- **æ—¥å¸¸å…ƒç´ **ï¼š{{routine_element_3}}
- **åå¸¸å…ƒç´ **ï¼š{{abnormal_element_3}}
- **æ˜ç¡®ç›®æ ‡**ï¼š{{goal_3}}
- **å¼ºåŠ²é˜»ç¢**ï¼š{{obstacle_3}}
- **æ— æ³•é€ƒé¿**ï¼š{{inescapable_3}}

### 3. è§’åº¦æ‹“å±•ï¼ˆè‡³å°‘3ä¸ªä¸åŒè§†è§’ï¼‰
- **è§†è§’1**ï¼š[ä¸»è§’è§†è§’]
- **è§†è§’2**ï¼š[é…è§’/åæ´¾è§†è§’]
- **è§†è§’3**ï¼š[æ—¶é—´çº¿/ç±»å‹å˜åŒ–è§†è§’]

### 4. æ ¸å¿ƒé—®é¢˜
- è¿™ä¸ªæ•…äº‹å…³äºä»€ä¹ˆï¼Ÿï¼ˆä¸»é¢˜ï¼‰
- ä¸»è§’æƒ³è¦ä»€ä¹ˆï¼Ÿï¼ˆç›®æ ‡ï¼‰
- ä»€ä¹ˆé˜»æ­¢äº†TAï¼Ÿï¼ˆé˜»ç¢ï¼‰
- ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å¼ƒï¼Ÿï¼ˆèµŒæ³¨ï¼‰

### 5. åç»­å»ºè®®
- æ¨èä¸‹ä¸€æ­¥ï¼š[ç»“æ„è®¾è®¡/è§’è‰²è®¾è®¡/åœºæ™¯è®¾è®¡]
- æ¨èç†ç”±ï¼š[è¯´æ˜åŸå› ]

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºç»“æ„åŒ–ç»“æœã€‚
""",
        variables=[
            TemplateVariable("inspiration_content", "string", True, "ç”¨æˆ·çš„çµæ„Ÿå†…å®¹"),
            TemplateVariable(
                "inspiration_type",
                "enum",
                False,
                "çµæ„Ÿç±»å‹",
                default_value="sentence",
                options=["sentence", "dream", "observation", "keyword"],
            ),
            TemplateVariable("preferred_genre", "string", False, "åå¥½çš„å°è¯´ç±»å‹"),
            TemplateVariable("conflict_type_1", "string", False, "ç¬¬ä¸€ä¸ªå†²çªç±»å‹", default_value="å¥‡å¹»"),
            TemplateVariable("routine_element_1", "string", False, "æ—¥å¸¸å…ƒç´ "),
            TemplateVariable("abnormal_element_1", "string", False, "åå¸¸å…ƒç´ "),
            TemplateVariable("goal_1", "string", False, "æ˜ç¡®ç›®æ ‡"),
            TemplateVariable("obstacle_1", "string", False, "å¼ºåŠ²é˜»ç¢"),
            TemplateVariable("inescapable_1", "string", False, "æ— æ³•é€ƒé¿çš„å›°å¢ƒ"),
            TemplateVariable("conflict_type_2", "string", False, "ç¬¬äºŒä¸ªå†²çªç±»å‹", default_value="æ‚¬ç–‘"),
            TemplateVariable("conflict_type_3", "string", False, "ç¬¬ä¸‰ä¸ªå†²çªç±»å‹", default_value="ç°å®ä¸»ä¹‰"),
        ],
    ),

    # ========== ç»“æ„è®¾è®¡æ¨¡æ¿ ==========
    "structure_design": PromptTemplate(
        id="structure_design",
        name="ä¸‰å¹•å¼ç»“æ„è®¾è®¡",
        category=PromptCategory.STRUCTURE,
        template="""# è§’è‰²ï¼šå°è¯´ç»“æ„è®¾è®¡å¸ˆ

## ä»»åŠ¡
åŸºäºæ ¸å¿ƒå†²çªï¼Œè®¾è®¡å®Œæ•´çš„æ•…äº‹ç»“æ„å’ŒèŠ‚å¥è“å›¾ã€‚

## è¾“å…¥ä¿¡æ¯
- æ ¸å¿ƒå†²çªï¼š{{core_conflict}}
- å°è¯´ç±»å‹ï¼š{{genre}}
- é¢„è®¡å­—æ•°ï¼š{{target_words}}å­—
- ç»“æ„åå¥½ï¼š{{structure_preference}}

## è¾“å‡ºè¦æ±‚

### 1. ç»“æ„æ¨è
- **æ¨èæ¨¡æ¿**ï¼š[ä¸‰å¹•å¼/è‹±é›„ä¹‹æ—…/æ‚¬ç–‘æ¨ç†/çˆ±æƒ…æ•…äº‹]
- **æ¨èç†ç”±**ï¼š
- **é€‚é…åº¦åˆ†æ**ï¼š

### 2. ä¸‰å¹•å¼è¯¦ç»†æ¡†æ¶

#### ç¬¬ä¸€å¹•ï¼šå»ºç½®ï¼ˆçº¦{{act1_percent}}%å­—æ•°ï¼Œçº¦{{act1_words}}å­—ï¼‰
**æ ¸å¿ƒç›®æ ‡**ï¼šè®©è¯»è€…å…³å¿ƒä¸»è§’ï¼Œè¿›å…¥æ•…äº‹ä¸–ç•Œ

**å…³é”®èŠ‚ç‚¹**ï¼š
- [ ] **å¼€åœºç”»é¢**ï¼ˆ{{opening_words}}å­—ï¼‰
  * åœºæ™¯è®¾ç½®ï¼š
  * å±•ç¤ºå†…å®¹ï¼š
  * æƒ…æ„ŸåŸºè°ƒï¼š

- [ ] **ä¸»è§’ä»‹ç»**ï¼ˆ{{intro_words}}å­—ï¼‰
  * å±•ç¤ºè€Œéè®²è¿°ï¼š
  * æ ¸å¿ƒç‰¹è´¨ï¼š
  * å½“å‰çŠ¶æ€ï¼š

- [ ] **è§¦å‘äº‹ä»¶**ï¼ˆ{{inciting_words}}å­—ï¼‰
  * äº‹ä»¶æè¿°ï¼š
  * æ‰“ç ´å¹³è¡¡ï¼š
  * ä¸»è§’ååº”ï¼š

- [ ] **ç¬¬ä¸€å¹•é«˜æ½®**ï¼ˆ{{act1_climax_words}}å­—ï¼‰
  * è¿›å…¥æ–°ä¸–ç•Œï¼š
  * æ— æ³•å›å¤´ï¼š
  * æƒ…æ„Ÿå†²å‡»ï¼š

#### ç¬¬äºŒå¹•ï¼šå¯¹æŠ—ï¼ˆçº¦{{act2_percent}}%å­—æ•°ï¼Œçº¦{{act2_words}}å­—ï¼‰
**æ ¸å¿ƒç›®æ ‡**ï¼šæŒç»­å‡çº§å†²çªï¼Œå¢åŠ èµŒæ³¨

**å…³é”®èŠ‚ç‚¹**ï¼š
- [ ] **è¯•ç‚¼é˜¶æ®µ**
  * å°ç›®æ ‡1ï¼š
  * å°ç›®æ ‡2ï¼š
  * å°ç›®æ ‡3ï¼š

- [ ] **ä¸­ç‚¹è½¬æŠ˜**ï¼ˆ{{midpoint_words}}å­—ï¼‰
  * è½¬æŠ˜å†…å®¹ï¼š
  * èŠ‚å¥å˜åŒ–ï¼š
  * æ–°ä¿¡æ¯ï¼š

- [ ] **ä¸€æ— æ‰€æœ‰æ—¶åˆ»**ï¼ˆ{{dark_night_words}}å­—ï¼‰
  * ç»å¢ƒè®¾ç½®ï¼š
  * æƒ…æ„Ÿä½è°·ï¼š
  * è½¬æœºä¼ç¬”ï¼š

#### ç¬¬ä¸‰å¹•ï¼šç»“å±€ï¼ˆçº¦{{act3_percent}}%å­—æ•°ï¼Œçº¦{{act3_words}}å­—ï¼‰
**æ ¸å¿ƒç›®æ ‡**ï¼šé‡Šæ”¾æ‰€æœ‰å¼ åŠ›ï¼Œå®Œæˆäººç‰©å¼§å…‰

**å…³é”®èŠ‚ç‚¹**ï¼š
- [ ] **æœ€ç»ˆå¯¹å†³å‡†å¤‡**
- [ ] **é«˜æ½®çˆ†å‘**ï¼ˆ{{climax_words}}å­—ï¼‰
  * ä¸‰é‡å·¥å…·ï¼š
    - æŠ‘åˆ¶ï¼š
    - æ„å¤–ï¼š
    - è½¬æŠ˜ï¼š

- [ ] **ç»“å±€å‘ˆç°**
- [ ] **æ–°å¹³è¡¡å»ºç«‹**

### 3. ç›®æ ‡åˆ†å±‚ä½“ç³»
```
å¤§ç›®æ ‡ï¼š{{ultimate_goal}}
â”œâ”€ ä¸­ç›®æ ‡1ï¼š{{mid_goal_1}}
â”‚  â”œâ”€ å°ç›®æ ‡1.1
â”‚  â”œâ”€ å°ç›®æ ‡1.2
â”‚  â””â”€ å°ç›®æ ‡1.3
â”œâ”€ ä¸­ç›®æ ‡2ï¼š{{mid_goal_2}}
â”‚  â””â”€ ...
â””â”€ ä¸­ç›®æ ‡3ï¼š{{mid_goal_3}}
   â””â”€ ...
```

### 4. ä¼ç¬”å¸ƒå±€
| ä¼ç¬” | ä½ç½® | å›æ”¶ä½ç½® | ç±»å‹ |
|------|------|----------|------|
| ... | ... | ... | ... |

### 5. æ‚¬å¿µè®¾ç½®æ¸…å•
- [ ] ç¬¬ä¸€ç« æ‚¬å¿µï¼š
- [ ] ä¸­ç‚¹æ‚¬å¿µï¼š
- [ ] é«˜æ½®å‰æ‚¬å¿µï¼š

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºç»“æ„åŒ–ç»“æœã€‚
""",
        variables=[
            TemplateVariable("core_conflict", "string", True, "æ ¸å¿ƒå†²çª"),
            TemplateVariable("genre", "string", True, "å°è¯´ç±»å‹"),
            TemplateVariable("target_words", "number", True, "ç›®æ ‡å­—æ•°"),
            TemplateVariable("structure_preference", "string", False, "ç»“æ„åå¥½", default_value="ä¸‰å¹•å¼"),
            TemplateVariable("act1_percent", "number", False, "ç¬¬ä¸€å¹•ç™¾åˆ†æ¯”", default_value=25),
            TemplateVariable("act2_percent", "number", False, "ç¬¬äºŒå¹•ç™¾åˆ†æ¯”", default_value=50),
            TemplateVariable("act3_percent", "number", False, "ç¬¬ä¸‰å¹•ç™¾åˆ†æ¯”", default_value=25),
            TemplateVariable("ultimate_goal", "string", True, "ç»ˆæç›®æ ‡"),
        ],
    ),

    # ========== è§’è‰²è®¾è®¡æ¨¡æ¿ ==========
    "character_profile": PromptTemplate(
        id="character_profile",
        name="ç«‹ä½“è§’è‰²æ¡£æ¡ˆåˆ›å»º",
        category=PromptCategory.CHARACTER,
        template="""# è§’è‰²ï¼šç«‹ä½“è§’è‰²å¡‘é€ å¸ˆ

## ä»»åŠ¡
åˆ›å»ºæ·±åº¦ç«‹ä½“çš„å°è¯´è§’è‰²ï¼Œè®©è§’è‰²æ´»èµ·æ¥ã€‚

## è¾“å…¥ä¿¡æ¯
- è§’è‰²å®šä½ï¼š{{role_type}}
- æ•…äº‹éœ€æ±‚ï¼š{{story_requirement}}
- æ ¸å¿ƒå†²çªï¼š{{core_conflict}}
- å‚è€ƒåŸå‹ï¼š{{reference_archetype}}

## è¾“å‡ºè¦æ±‚ - è§’è‰²ç«‹ä½“7è¦ç´ æ¡£æ¡ˆ

### 1. é‡å¤è¡Œä¸ºï¼ˆç¬¬ä¸€å°è±¡/æ ‡å¿—æ€§åŠ¨ä½œï¼‰
- **å¤–è²Œç‰¹å¾**ï¼š
- **æ ‡å¿—æ€§åŠ¨ä½œ**ï¼š
- **è¯­è¨€ç‰¹ç‚¹**ï¼š
- **ç¬¬ä¸€å°è±¡è®¾è®¡**ï¼š
- **è¯»è€…è®°å¿†ç‚¹**ï¼š

### 2. åå·®ç»†èŠ‚ï¼ˆå¤–è¡¨vså†…åœ¨ï¼‰
- **å¤–è¡¨ç»™äººçš„å°è±¡**ï¼š
- **å†…åœ¨çœŸå®é¢è²Œ**ï¼š
- **åå·®å…·ä½“è¡¨ç°**ï¼š
- **æ­ç¤ºåå·®çš„åœºæ™¯**ï¼š

### 3. æˆé•¿è½¨è¿¹ï¼ˆå¼€å§‹vsç»“æŸï¼‰
- **æ•…äº‹å¼€å§‹æ—¶çš„çŠ¶æ€**ï¼š
- **æ ¸å¿ƒç¼ºé™·/å¼±ç‚¹**ï¼š
- **æ•…äº‹ç»“æŸæ—¶çš„çŠ¶æ€**ï¼š
- **è½¬å˜è¿‡ç¨‹è®¾è®¡**ï¼š
- **äººç‰©å¼§å…‰ç±»å‹**ï¼š

### 4. ç‹¬ç‰¹è§‚å¯Ÿï¼ˆä¸–ç•Œè§‚ï¼‰
- **TAçœ¼ä¸­çš„ä¸–ç•Œ**ï¼š
- **ç‹¬ç‰¹çš„è§‚å¯Ÿè§’åº¦**ï¼š
- **å¯èƒ½çš„å†…å¿ƒç‹¬ç™½é£æ ¼**ï¼š
- **å¯¹äº‹ç‰©çš„ç‰¹æ®Šååº”**ï¼š

### 5. ç‰¹æ®Šå¤©èµ‹/æ€ªç™–
- **ç‰¹æ®Šèƒ½åŠ›**ï¼š
- **ä¸ªäººæ€ªç™–**ï¼š
- **è®°å¿†ç‚¹å¼ºåŒ–**ï¼š
- **å…¶ä»–äººå¯¹TAçš„è¯„ä»·**ï¼š

### 6. çœŸå®ç¼ºé™·
- **æ ¸å¿ƒæ€§æ ¼ç¼ºé™·**ï¼š
- **è¿™ä¸ªç¼ºé™·å¦‚ä½•åˆ¶é€ éº»çƒ¦**ï¼š
- **ä¸ºä»€ä¹ˆè¿™ä¸ªç¼ºé™·é‡è¦**ï¼š
- **æ˜¯å¦ä¼šå…‹æœ/è½¬åŒ–**ï¼š

### 7. å¼ºçƒˆåŠ¨æœº
- **è¡¨å±‚åŠ¨æœº**ï¼ˆTAè¯´æƒ³è¦ä»€ä¹ˆï¼‰ï¼š
- **æ·±å±‚åŠ¨æœº**ï¼ˆTAçœŸæ­£æƒ³è¦ä»€ä¹ˆï¼‰ï¼š
- **ä¸ºä»€ä¹ˆè¿™ä¸ªåŠ¨æœºå¼ºçƒˆ**ï¼š
- **åŠ¨æœºæ¥æº**ï¼ˆèƒŒæ™¯æ•…äº‹ï¼‰ï¼š

## æ ¸å¿ƒåŠ¨æœºé©±åŠ¨ç³»ç»Ÿ

### è¡Œä¸ºé€»è¾‘é“¾
```
æ€§æ ¼ç‰¹å¾ â†’ æ ¸å¿ƒåŠ¨æœº â†’ è¡Œä¸ºå†³ç­– â†’ è¡ŒåŠ¨æ‰§è¡Œ â†’ ç»“æœåé¦ˆ
    â†‘                                                     â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æˆé•¿/å˜åŒ– â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®æ ‡ä½“ç³»
- **å¤§ç›®æ ‡**ï¼š
- **ä¸­æœŸç›®æ ‡**ï¼š
- **çŸ­æœŸç›®æ ‡**ï¼š

### é˜»ç¢ä½“ç³»
- **å¤–éƒ¨é˜»ç¢**ï¼š
- **å†…éƒ¨é˜»ç¢**ï¼š
- **å“²å­¦é˜»ç¢**ï¼š

## å…³ç³»ç½‘ç»œ
- **ä¸ä¸»è§’çš„å…³ç³»**ï¼š
- **ä¸å…¶ä»–è§’è‰²çš„å…³ç³»**ï¼š
- **å…³ç³»å‘å±•æ›²çº¿**ï¼š

## åœºæ™¯åº”ç”¨ç¤ºä¾‹
ç»™å‡º3ä¸ªå±•ç¤ºè§’è‰²ç‰¹è´¨çš„åœºæ™¯è®¾è®¡ï¼š
1. **åœºæ™¯ä¸€**ï¼š[å±•ç¤ºç‰¹è´¨A]
2. **åœºæ™¯äºŒ**ï¼š[å±•ç¤ºç‰¹è´¨B]
3. **åœºæ™¯ä¸‰**ï¼š[å±•ç¤ºç‰¹è´¨C]

## å¯¹è¯é£æ ¼ç¤ºä¾‹
- **å£å¤´ç¦…**ï¼š
- **è¯´è¯ç‰¹ç‚¹**ï¼š
- **å¯¹è¯ç¤ºä¾‹**ï¼ˆ3å¥ï¼‰ï¼š

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºç»“æ„åŒ–ç»“æœã€‚
""",
        variables=[
            TemplateVariable(
                "role_type",
                "enum",
                True,
                "è§’è‰²å®šä½",
                options=["protagonist", "antagonist", "supporting", "minor"],
            ),
            TemplateVariable("story_requirement", "string", True, "è§’è‰²åœ¨æ•…äº‹ä¸­çš„ä½œç”¨"),
            TemplateVariable("core_conflict", "string", True, "æ ¸å¿ƒå†²çª"),
            TemplateVariable("reference_archetype", "string", False, "å‚è€ƒåŸå‹"),
        ],
    ),

    # ========== åœºæ™¯è“å›¾æ¨¡æ¿ ==========
    "scene_blueprint": PromptTemplate(
        id="scene_blueprint",
        name="åœºæ™¯è“å›¾è®¾è®¡",
        category=PromptCategory.SCENE,
        template="""# è§’è‰²ï¼šæƒ…èŠ‚ç¼–ç»‡å¤§å¸ˆ

## ä»»åŠ¡
åŸºäºç»“æ„æ¡†æ¶ï¼Œç¼–ç»‡å…·ä½“çš„æƒ…èŠ‚å†…å®¹å’Œåœºæ™¯ã€‚

## è¾“å…¥ä¿¡æ¯
- **å½“å‰ç« èŠ‚**ï¼šç¬¬{{chapter_number}}ç« 
- **ç« èŠ‚ç›®æ ‡**ï¼š{{chapter_goal}}
- **æ¶‰åŠè§’è‰²**ï¼š{{characters}}
- **å‰æƒ…æè¦**ï¼š{{previous_context}}
- **åç»­é“ºå«**ï¼š{{future_setup}}

## è¾“å‡ºè¦æ±‚

### 1. åœºæ™¯è“å›¾
```
åœºæ™¯ç±»å‹ï¼š[åŠ¨ä½œ/æƒ…æ„Ÿ/å¯¹è¯/è¿‡æ¸¡]
æ ¸å¿ƒç›®æ ‡ï¼š[ä¸»è§’æƒ³è¾¾æˆä»€ä¹ˆ]
æ ¸å¿ƒéšœç¢ï¼š[ä»€ä¹ˆé˜»æ­¢TA]
å¤±è´¥ä»£ä»·ï¼š[å¤±è´¥çš„åæœ]
æƒ…ç»ªåŸºè°ƒï¼š[ç´§å¼ /è½»æ¾/æ‚²ä¼¤/å–œæ‚¦]
```

### 2. èŠ‚æ‹è®¾è®¡ï¼ˆè§’è‰²å…‹æœéšœç¢çš„å°è¯•åºåˆ—ï¼‰
```
èŠ‚æ‹1ï¼š[å°è¯•æ–¹å¼]
  â†“
  éšœç¢ï¼š[ä»€ä¹ˆé˜»æ­¢äº†]
  ç»“æœï¼š[å¤±è´¥/éƒ¨åˆ†æˆåŠŸ]

èŠ‚æ‹2ï¼š[æ–°çš„å°è¯•ï¼Œå¿…é¡»å‡çº§]
  â†“
  éšœç¢ï¼š[æ›´å¤§çš„é˜»ç¢]
  ç»“æœï¼š[...]

èŠ‚æ‹3ï¼š[æœ€åå°è¯•ï¼Œç”Ÿæ­»ç›¸å…³]
  â†“
  ç»“æœï¼š[çªç ´åœºæ™¯]
```

### 3. å†²çªå‡çº§æ£€æŸ¥
- [ ] æ¯ä¸ªèŠ‚æ‹éƒ½æ¯”ä¸Šä¸€ä¸ªæ›´éš¾
- [ ] ä¸»è§’æŒç»­è¡ŒåŠ¨
- [ ] æœ‰æ­£å‘åé¦ˆ
- [ ] ç¬¦åˆè§’è‰²è¡Œä¸ºé€»è¾‘

### 4. æ„Ÿå®˜å…ƒç´ æ•´åˆ
- **è§†è§‰**ï¼š[3ä¸ªå…³é”®è§†è§‰å…ƒç´ ]
- **å¬è§‰**ï¼š[å£°éŸ³ç»†èŠ‚]
- **è§¦è§‰**ï¼š[è§¦æ„Ÿä½“éªŒ]
- **å—…è§‰**ï¼š[æ°”å‘³æå†™]
- **å‘³è§‰**ï¼š[å¦‚é€‚ç”¨]

### 5. å¯¹è¯è¦ç‚¹
- æœ¬åœºæ™¯å…³é”®å¯¹è¯ï¼ˆ3-5å¥ï¼‰
- æ½œå°è¯è®¾è®¡
- ä¿¡æ¯é‡Šæ”¾æ§åˆ¶

### 6. é•œå¤´è§„åˆ’
- **å¼€åœºé•œå¤´**ï¼š[å¦‚ä½•å¼€å§‹]
- **ä¸­æ™¯åˆ‡æ¢**ï¼š[ä¸­é—´å¦‚ä½•è½¬æ¢]
- **ç»“å°¾é•œå¤´**ï¼š[å¦‚ä½•ç»“æŸï¼Œåˆ¶é€ æ‚¬å¿µ]

### 7. æ‚¬å¿µ/é’©å­
- **åœºæ™¯ç»“æŸæ—¶çš„é’©å­**ï¼š
- **å¼•å‘è¯»è€…ä»€ä¹ˆç–‘é—®**ï¼š

## è´¨é‡è‡ªæ£€
- [ ] æ¨åŠ¨æƒ…èŠ‚äº†å—
- [ ] å±•ç¤ºè§’è‰²äº†å—
- [ ] æœ‰å†²çªå—
- [ ] æœ‰ä¿¡æ¯é‡å—
- [ ] èŠ‚å¥å¯¹å—

è¯·ä»¥JSONæ ¼å¼è¾“å‡ºç»“æ„åŒ–ç»“æœã€‚
""",
        variables=[
            TemplateVariable("chapter_number", "number", True, "ç« èŠ‚å·"),
            TemplateVariable("chapter_goal", "string", True, "ç« èŠ‚ç›®æ ‡"),
            TemplateVariable("characters", "string", True, "æ¶‰åŠè§’è‰²"),
            TemplateVariable("previous_context", "string", True, "å‰æƒ…æè¦"),
            TemplateVariable("future_setup", "string", True, "åç»­é“ºå«"),
        ],
    ),

    # ========== å¯¹è¯ä¼˜åŒ–æ¨¡æ¿ ==========
    "dialogue_optimize": PromptTemplate(
        id="dialogue_optimize",
        name="å¯¹è¯ä¼˜åŒ–",
        category=PromptCategory.DIALOGUE,
        template="""# è§’è‰²ï¼šå¯¹è¯åˆ›ä½œä¸“å®¶

## ä»»åŠ¡
ä¼˜åŒ–ç»™å®šçš„å¯¹è¯æ®µè½ï¼Œä½¿å…¶æ›´ç¬¦åˆæ•…äº‹è¦æ±‚ã€‚

## è¾“å…¥ä¿¡æ¯
- **åŸå§‹å¯¹è¯**ï¼š
{{original_dialogue}}

- **è§’è‰²ä¿¡æ¯**ï¼š
{{character_info}}

- **åœºæ™¯ç›®æ ‡**ï¼š{{scene_goal}}
- **ä¼˜åŒ–é‡ç‚¹**ï¼š{{optimization_focus}}

## ä¼˜åŒ–åŸåˆ™

### 1. ç¬¦åˆäººè®¾
- å¯¹è¯å¿…é¡»ç¬¦åˆè§’è‰²çš„èƒŒæ™¯ã€æ•™è‚²ã€ç¯å¢ƒå’Œæ€§æ ¼
- æ¯ä¸ªè§’è‰²çš„è¯´è¯æ–¹å¼éƒ½æ˜¯ç‹¬ç‰¹çš„

### 2. å¯¹è¯å¿…é¡»æœ‰ç›®çš„
- æ¨åŠ¨æƒ…èŠ‚å‘å±•
- å±•ç°äººç‰©æ€§æ ¼
- æä¾›å…³é”®ä¿¡æ¯
- åˆ¶é€ å†²çª/å¼ åŠ›

### 3. ä¼˜åŒ–æŠ€å·§
- å‹ç¼©å¯¹è¯ï¼Œåˆ é™¤å†—ä½™
- æ·»åŠ æ½œå°è¯
- ç”¨é—®é¢˜å›ç­”é—®é¢˜
- æ²‰é»˜ä¹Ÿæ˜¯æ€åº¦
- è¯ä¸€åŠç•™ä¸€åŠ

### 4. é¿å…æ¸…å•
âŒ è¯´æ˜æ€§å¯¹è¯
âŒ é—®å€™å¯’æš„
âŒ è‡ªæˆ‘ä»‹ç»
âŒ çº¯ç²¹çš„é—²èŠ
âŒ æ¯ä¸ªäººè¯´è¯æ–¹å¼ä¸€æ ·

## è¾“å‡ºè¦æ±‚

### ä¼˜åŒ–åçš„å¯¹è¯
{{optimized_dialogue}}

### ä¼˜åŒ–è¯´æ˜
1. **åˆ é™¤çš„å†…å®¹**åŠåŸå› 
2. **æ·»åŠ çš„æ½œå°è¯**åŠå«ä¹‰
3. **è°ƒæ•´çš„èŠ‚å¥**åŠæ•ˆæœ
4. **å…¶ä»–æ”¹è¿›ç‚¹**

è¯·ä»¥æ¸…æ™°çš„æ ¼å¼è¾“å‡ºä¼˜åŒ–ç»“æœã€‚
""",
        variables=[
            TemplateVariable("original_dialogue", "string", True, "åŸå§‹å¯¹è¯"),
            TemplateVariable("character_info", "string", True, "è§’è‰²ä¿¡æ¯"),
            TemplateVariable("scene_goal", "string", True, "åœºæ™¯ç›®æ ‡"),
            TemplateVariable(
                "optimization_focus",
                "enum",
                False,
                "ä¼˜åŒ–é‡ç‚¹",
                options=["all", "subtext", "rhythm", "character", "conflict"],
                default_value="all",
            ),
        ],
    ),

    # ========== è´¨é‡è¯Šæ–­æ¨¡æ¿ ==========
    "quality_diagnosis": PromptTemplate(
        id="quality_diagnosis",
        name="è´¨é‡å…¨é¢è¯Šæ–­",
        category=PromptCategory.EDITING,
        template="""# è§’è‰²ï¼šå°è¯´è´¨æ£€ä¸ä¿®æ”¹ä¸“å®¶

## ä»»åŠ¡
å¯¹å°è¯´åˆç¨¿è¿›è¡Œå…¨é¢è¯Šæ–­å’Œä¿®æ”¹æå‡ã€‚

## è¾“å…¥ä¿¡æ¯
- **é¡¹ç›®ä¿¡æ¯**ï¼š
{{project_info}}

- **æ£€æŸ¥èŒƒå›´**ï¼š{{check_scope}}
- **å…³æ³¨é‡ç‚¹**ï¼š{{focus_areas}}

## è¾“å‡ºè¦æ±‚

### ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯Šæ–­æŠ¥å‘Š

#### 1. ç»“æ„é—®é¢˜
| é—®é¢˜ç±»å‹ | ä¸¥é‡ç¨‹åº¦ | ä½ç½® | é—®é¢˜æè¿° | å»ºè®®ä¿®æ”¹ |
|----------|----------|------|----------|----------|
| ...      | é«˜/ä¸­/ä½ | ç« èŠ‚ | ...      | ...      |

**æ£€æŸ¥é¡¹**ï¼š
- [ ] ä¸‰å¹•å¼æ¯”ä¾‹æ˜¯å¦åˆç†
- [ ] æ¯ä¸ªåœºæ™¯æ˜¯å¦æœ‰ç”¨
- [ ] æƒ…èŠ‚æ¨è¿›æ˜¯å¦æµç•…
- [ ] é«˜æ½®æ˜¯å¦å¤Ÿçˆ½
- [ ] ç»“å±€æ˜¯å¦å®Œæ•´

#### 2. äººç‰©é—®é¢˜
| è§’è‰² | é—®é¢˜ç±»å‹ | ä½ç½® | é—®é¢˜æè¿° | å»ºè®® |
|------|----------|------|----------|------|
| ...  | ...      | ...  | ...      | ...  |

**æ£€æŸ¥é¡¹**ï¼š
- [ ] ä¸»è§’è®¨å–œå—
- [ ] è¡Œä¸ºç¬¦åˆäººè®¾å—
- [ ] å¯¹è¯ç¬¦åˆæ€§æ ¼å—
- [ ] äººç‰©æœ‰å¼§å…‰å—
- [ ] é…è§’æœ‰ä½œç”¨å—

#### 3. æƒ…èŠ‚é—®é¢˜
| é—®é¢˜ | ä½ç½® | ä¸¥é‡åº¦ | é—®é¢˜æè¿° | ä¿®æ”¹å»ºè®® |
|------|------|--------|----------|----------|
| ...  | ...  | ...    | ...      | ...      |

**æ£€æŸ¥é¡¹**ï¼š
- [ ] å†²çªå¤Ÿå¼ºå—
- [ ] æœ‰è€å¥—è¿¹è±¡å—
- [ ] å› æœå…³ç³»åˆç†å—
- [ ] è½¬æŠ˜åˆç†å—
- [ ] ä¼ç¬”å›æ”¶äº†å—

#### 4. æ–‡å­—é—®é¢˜
| ç±»å‹ | æ•°é‡ | ç¤ºä¾‹ | ä¿®æ”¹å»ºè®® |
|------|------|------|----------|
| è®²è¿°è€Œéå±•ç¤º | Xå¤„ | ... | ... |
| è¿‡åº¦æå†™ | Xå¤„ | ... | ... |
| é€»è¾‘æ¼æ´ | Xå¤„ | ... | ... |
| å‰åçŸ›ç›¾ | Xå¤„ | ... | ... |

### ç¬¬äºŒéƒ¨åˆ†ï¼šå…·ä½“ä¿®æ”¹æ–¹æ¡ˆ

#### ä¿®æ”¹ä¼˜å…ˆçº§
```
ğŸ”´ ç´§æ€¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰ï¼š
- [ ] é—®é¢˜1 â†’ ä¿®æ”¹æ–¹æ¡ˆ
- [ ] é—®é¢˜2 â†’ ä¿®æ”¹æ–¹æ¡ˆ

ğŸŸ¡ é‡è¦ï¼ˆå»ºè®®ä¿®æ”¹ï¼‰ï¼š
- [ ] é—®é¢˜1 â†’ ä¿®æ”¹æ–¹æ¡ˆ
- [ ] é—®é¢˜2 â†’ ä¿®æ”¹æ–¹æ¡ˆ

ğŸŸ¢ å¯é€‰ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰ï¼š
- [ ] é—®é¢˜1 â†’ ä¿®æ”¹æ–¹æ¡ˆ
```

#### ä¿®æ”¹ä¸‰åŸåˆ™åº”ç”¨
1. **åˆ¶é€ è¿é”ååº”**
   - æ£€æŸ¥å› æœå…³ç³»
   - å¢å¼ºæƒ…èŠ‚è”åŠ¨

2. **æ€§æ ¼å†³å®šå‘½è¿**
   - ç¡®ä¿è¡Œä¸ºç¬¦åˆäººè®¾
   - åˆ é™¤ä¸åˆç†ä¸¾åŠ¨

3. **æ„æ–™ä¹‹å¤–ï¼Œæƒ…ç†ä¹‹ä¸­**
   - æ£€æŸ¥è½¬æŠ˜åˆç†æ€§
   - å¢åŠ é“ºå«

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¶¦è‰²å»ºè®®

#### ç”»é¢æ„Ÿå¢å¼º
åˆ—å‡ºéœ€è¦"å±•ç¤ºè€Œéè®²è¿°"çš„ä½ç½®ï¼š
| ä½ç½® | åŸæ–‡ | æ”¹å†™æ–¹å‘ |
|------|------|----------|
| XXé¡µ | "ä»–æ„Ÿåˆ°æ„¤æ€’" | å±•ç¤ºèº«ä½“ååº”ï¼šæ‹³å¤´æç™½ã€é’ç­‹æš´èµ· |

#### å¯¹è¯ä¼˜åŒ–
| ä½ç½® | é—®é¢˜ | ä¼˜åŒ–æ–¹å‘ |
|------|------|----------|
| XXé¡µ | ä¿¡æ¯é‡å°‘ | å¢åŠ å†²çª/æ½œå°è¯ |

#### èŠ‚å¥è°ƒæ•´
| ä½ç½® | å½“å‰èŠ‚å¥ | å»ºè®®è°ƒæ•´ | æ–¹æ³• |
|------|----------|----------|------|
| XXç«  | å¤ªæ‹–æ²“ | åŠ å¿« | åˆ é™¤æ— å…³åœºæ™¯/å¢åŠ èŠ‚æ‹ |

### ç¬¬å››éƒ¨åˆ†ï¼šæœ€ç»ˆæ£€æŸ¥æ¸…å•
å®Œæˆä¿®æ”¹åï¼Œç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š
- [ ] æ‰€æœ‰ç´§æ€¥é—®é¢˜å·²è§£å†³
- [ ] ä¸»è§’å®Œæˆä½¿å‘½
- [ ] ä¸»é¢˜è¡¨è¾¾æ¸…æ™°
- [ ] äººç‰©å¼§å…‰å®Œæ•´
- [ ] æ”¯çº¿å’Œå‘éƒ½å¡«äº†
- [ ] é«˜æ½®å¤Ÿçˆ½
- [ ] ç»“å±€å®Œæ•´
- [ ] é£æ ¼ç»Ÿä¸€
- [ ] æ— æ˜æ˜¾æ¼æ´

## è¾“å‡ºæ ¼å¼
1. å…ˆè¾“å‡ºè¯Šæ–­æŠ¥å‘Š
2. å†è¾“å‡ºå…·ä½“ä¿®æ”¹æ–¹æ¡ˆ
3. æœ€åç»™å‡ºä¿®æ”¹åçš„ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰

è¯·ä»¥æ¸…æ™°çš„æ ¼å¼è¾“å‡ºå®Œæ•´è¯Šæ–­ã€‚
""",
        variables=[
            TemplateVariable("project_info", "string", True, "é¡¹ç›®ä¿¡æ¯"),
            TemplateVariable(
                "check_scope",
                "enum",
                False,
                "æ£€æŸ¥èŒƒå›´",
                options=["full", "structure", "character", "plot", "writing"],
                default_value="full",
            ),
            TemplateVariable("focus_areas", "string", False, "å…³æ³¨é‡ç‚¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰"),
        ],
    ),
}


class PromptTemplateManager:
    """æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨."""

    def __init__(self):
        """åˆå§‹åŒ–æ¨¡æ¿ç®¡ç†å™¨."""
        self.templates = PROMPT_TEMPLATES

    def get_template(self, template_id: str) -> Optional[PromptTemplate]:
        """è·å–æ¨¡æ¿.

        Args:
            template_id: æ¨¡æ¿ID

        Returns:
            PromptTemplateå¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›None
        """
        return self.templates.get(template_id)

    def fill_template(
        self, template_id: str, variables: Dict[str, Any]
    ) -> str:
        """å¡«å……æ¨¡æ¿.

        Args:
            template_id: æ¨¡æ¿ID
            variables: æ¨¡æ¿å˜é‡

        Returns:
            å¡«å……åçš„æç¤ºè¯å­—ç¬¦ä¸²
        """
        template = self.get_template(template_id)
        if not template:
            raise ValueError(f"Template not found: {template_id}")

        # éªŒè¯å¿…éœ€å˜é‡
        for var in template.variables:
            if var.required and var.name not in variables:
                raise ValueError(f"Required variable missing: {var.name}")

        # å¡«å……å˜é‡
        result = template.template
        for var in template.variables:
            placeholder = f"{{{{{var.name}}}}}"
            value = variables.get(var.name, var.default_value or "")
            result = result.replace(placeholder, str(value))

        return result

    def add_project_context(self, template: str, project: Dict[str, Any]) -> str:
        """æ·»åŠ é¡¹ç›®ç‰¹å®šä¸Šä¸‹æ–‡.

        Args:
            template: æç¤ºè¯æ¨¡æ¿
            project: é¡¹ç›®ä¿¡æ¯

        Returns:
            æ·»åŠ äº†é¡¹ç›®ä¸Šä¸‹æ–‡çš„æç¤ºè¯
        """
        context = f"""
## é¡¹ç›®ä¸Šä¸‹æ–‡
- é¡¹ç›®åç§°ï¼š{project.get('title', 'Untitled')}
- ç±»å‹ï¼š{project.get('genre', 'N/A')}
- ç›®æ ‡å­—æ•°ï¼š{project.get('target_word_count', 'N/A')}
- å½“å‰è¿›åº¦ï¼š{project.get('current_word_count', 0)}/{project.get('target_word_count', 'N/A')}
- å½“å‰é˜¶æ®µï¼š{project.get('status', 'N/A')}
        """.strip()

        return template + "\n\n" + context

    def get_templates_by_category(
        self, category: PromptCategory
    ) -> List[PromptTemplate]:
        """æŒ‰ç±»åˆ«è·å–æ¨¡æ¿.

        Args:
            category: æ¨¡æ¿ç±»åˆ«

        Returns:
            è¯¥ç±»åˆ«çš„æ‰€æœ‰æ¨¡æ¿
        """
        return [t for t in self.templates.values() if t.category == category and t.is_active]

    def get_all_templates(self) -> List[PromptTemplate]:
        """è·å–æ‰€æœ‰æ´»è·ƒæ¨¡æ¿.

        Returns:
            æ‰€æœ‰æ´»è·ƒçš„æ¨¡æ¿åˆ—è¡¨
        """
        return [t for t in self.templates.values() if t.is_active]
